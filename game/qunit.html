<!DOCTYPE html>
<html>
<head>
<!--
	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />
 -->
	<link rel="stylesheet" href="./css/qunit.css" type="text/css" media="screen" />
	<script src="./js/jquery-1.7.1.min.js"></script>
	<script src="./js/qunit.js"></script>
	<script src="./js/main.js"></script>

	<script>
<!--
function counter() {
	var count = 0;
	return {
		inc: function() { count++; },
		check: function() { return count;}
	}
}
	
$(function(){
	module("Module main");
	test("should init and move from loader to content when load is complete", function() {
		// GIVEN
		var body_elt=[];
		var loader = { append: function() {}, fadeOut: function() {}	}
		var content = { append: function(e) {}, fadeIn: function() {}, hide: function() {} }
		var _jquery = function (s) { return {
			'#container' : { append : function(e) { body_elt.push(e);} },
			'<div id="loader"/>' : loader,
			'<div id="content"/>' : content
		}[s];}
		
		// WHEN
		inject(_jquery).init( function(e, c, x) { strictEqual(loader,e); x()} );

		// THEN
		deepEqual(body_elt.sort(),[loader,content].sort());
		expect(2);
	});

	test("should build progress bar and run finish when loading is complete", function () {
		// GIVEN
		var size = 5;
		var c = counter();
		var texts = ['aa666', 'bb42', 'cc8', 'dd0', 'ee13'];
		var pb = {
			text: function (text) {strictEqual(text, texts[c.check()]);c.inc();},
			progressbar: function(v) { deepEqual(v,{value:c.check()*20})}};
		var _jquery = function (x) {equal(x,'<span id="progressbar"/>'); return pb};
		var loader = { append: function(x) {strictEqual(x, pb)} };
		var finish = function () {equal(c.check(),size);};
		var bar = inject(_jquery).progress(loader, size, finish);

		// WHEN
		for (var i=0; i < size ; i++) { bar(texts[i]); }
		
		// THEN
		expect(14);
	})
	
	test("should build history_mapper and hash-mapping", function () {
		// GIVEN
		var _window = {location:{}};
		var _inner;
		var _context = {};
		var _jquery = function (s) { strictEqual(s,_window); return { bind: function(a, b) { equal(a,'hashchange'); _inner = b;} } }
		_jquery.each = function (o,f) { $.each(o,f); }
		
		inject(_jquery).history_mapper(_window, _context, [
			{ valid: function (h) { equal(h,'#plop'); return false }, run: function (c) { ok(false,'should never be called');} },
			{ valid: function (h) { equal(h,'#plop'); return true }, run: function (c) { equal(c,_context); } },
			{ valid: function (h) { ok(false,'should never be called'); }, run: function (c) { ok(false,'should never be called');} }
		]);
		
		_window.location.hash='#plop';
	
		// WHEN
		_inner();
		
		// THEN
		expect(5);
	})
	
	test("should build view", function () {
		expect(1);
	})
	
	module("Module i18n");
	test("should l10n according to i18n init, full scan", function () {
		// Basic translation i18n tests
		equal( inject({}).i18n_full({}) ('xxx'), 'xxx');
		equal( inject({}).i18n_full({}) ('${i18n.xxx}'), '${i18n.xxx}');
		equal( inject({}).i18n_full({}) ('${i18n.xxx(plip)}'), 'plip');
		equal( inject({}).i18n_full({}) ('${i18n.xxx(plip)} uu  ${i18n.xxx}'), 'plip uu  plip');
		equal( inject({}).i18n_full({'xxx':'yyy'}) ('${i18n.xxx}'), 'yyy');
		equal( inject({}).i18n_full({'xxx':'yyy'}) ('${i18n.xxx(plip)}'), 'yyy');
		equal( inject({}).i18n_full({'xxx':'yyy'}) ('${i18n.xxx(plip)} uu  ${i18n.xxx}'), 'yyy uu  yyy');
		
		// Multi translation i18n tests
		var l10n = inject({}).i18n_full({
			subscribe_legend: "Register",
			subscribe_login: "Your login",
			subscribe_email: "Your email",
			subscribe_password: "Enter password",
			subscribe_password_confirmation: "Confirm password",
			subscribe_submit: "Join now !"
		});
		
		var content = '<fieldset id="subscribe">'+
			'<legend>${i18n.subscribe_legend}</legend>'+
			'<input name="login" type="text" alt="${i18n.subscribe_login}" title="${i18n.subscribe_login}" tabindex="1"/>'+
			'<input name="email" type="text" alt="${i18n.subscribe_email}" title="${i18n.subscribe_email}" tabindex="2"/>'+
			'<input name="pwd_1" type="password" alt="${i18n.subscribe_password}" title="${i18n.subscribe_password}" tabindex="4"/>'+
			'<input name="pwd_2" type="password" alt="${i18n.subscribe_password_confirmation}" title="${i18n.subscribe_password_confirmation}" tabindex="5"/>'+
			'<input value="${i18n.subscribe_submit}" type="submit"/>'+
			'</fieldset>';

		equal(
			l10n(content),
			'<fieldset id="subscribe">'+
			'<legend>Register</legend>'+
			'<input name="login" type="text" alt="Your login" title="Your login" tabindex="1"/>'+
			'<input name="email" type="text" alt="Your email" title="Your email" tabindex="2"/>'+
			'<input name="pwd_1" type="password" alt="Enter password" title="Enter password" tabindex="4"/>'+
			'<input name="pwd_2" type="password" alt="Confirm password" title="Confirm password" tabindex="5"/>'+
			'<input value="Join now !" type="submit"/>'+
			'</fieldset>'
		);
	})
});
-->
	</script>
  
</head>
<body>
  <h1 id="qunit-header">Test Visual components</h1>
 <h2 id="qunit-banner"></h2>
 <div id="qunit-testrunner-toolbar"></div>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
 <div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
