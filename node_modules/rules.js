


exports.rest = function (rest) {
	return {
		valid : function (u) {return u.req.url.indexOf('/j/')==0;},
		run : function (u) {
			u.res.writeHead(200, {'Content-Type': 'text/json'});
			u.res.end('{}');
		}
	};
}

exports.static = function (default_location, urlparser, mime, fs) {
	return {
		valid : function (u) {return true},
		run : function (u) {
			var parsed = urlparser(u.req.url, true);
			var current_path='./static' + parsed.pathname;

			var onError = function (err) {
				console.error(err.message); // ERROR: cannot open `/path/to/foo.pdf' (No such file or directory)
				u.res.writeHead(404, {'Content-Type': 'text/html'});
				u.res.end("<html><body>404 not found</body></html>");
			}

			var onSuccess = function (path,data) {
				var type = mime(path);
				console.log('Detected mime type: %s -> %s', path, type);
				u.res.writeHead(200, {'Content-Type': type});
				u.res.end(data);
			}

			var runPath = function (path) {
				console.log("runPath(%s)",path);
				// check what is this file					
				fs.stat(path, function (err,stats) {
					if (err) {
						onError(err);
					} else {
						if (stats.isDirectory()) {
							runPath((path+default_location).replace(/\/+/g,'/'));
						} else {
							fs.readFile(path, function (err, data) {
								if (err) {
									onError(err);
								} else {
									onSuccess(path, data);
								}
							});							
						}
					}
				});
			}
			
			runPath(current_path);
		}
	};
}
