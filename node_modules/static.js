/*
 * Copyright 2010 Nicolas Lochet Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License. You may obtain a copy of the License at
 *      
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and limitations under the License.
 */

exports.inject = function (logger, http_status, urlparser, fs, default_location) {
	var injected = {};
	default_location = default_location || 'index.html';
	
	injected.run_path = function (path, url, res) {
		logger.trace("run_path({}, {}, {})", path, url, res);
		// check what is this file					
		fs.stat(path, function (err, stats) {
			//logger.trace("{} stats: {}", path, stats);
			if (err) {
				logger.error(err.message);
				http_status(404)(res);
			} else {
				if (stats.isDirectory()) {
					logger.trace("{} is Directory", path);
					if (path.match(/[^\/]$/)) {
						logger.trace("{} do not finish with /", path);
						http_status(302)(res, url+'/');
					} else {
						injected.run_path((path+'/'+default_location).replace(/\/+/g,'/'), url, res);
					}
				} else {
					logger.trace("{} is File", path);
					fs.readFile(path, function (err, data) {
						if (err) {
							logger.error(err.message);
							http_status(404)(res);
						} else {
							http_status(200)(res, path, data);
						}
					});							
				}
			}
		});
	}
	
	injected.build = function () {
		return function (u) {
			var parsed = urlparser(u.req.url, true);
			var current_path='./static' + parsed.pathname;
			injected.run_path(current_path, u.req.url, u.res);
		}	
	}
	return injected;
}
